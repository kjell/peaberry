#!/usr/bin/ruby
# -*- encoding: UTF-8 -*-

require 'rubygems'
begin
  require 'bundler/setup'
rescue LoadError => e
  # ignore
end

require 'peaberry'
require 'webrick'
require 'webrick/https'
require 'openssl'

ssl_info = DATA.read
ssl_cert = ssl_info.scan(/(-----BEGIN CERTIFICATE-----.+?-----END CERTIFICATE-----)/m)[0][0]
ssl_key  = ssl_info.scan(/(-----BEGIN RSA PRIVATE KEY-----.+?-----END RSA PRIVATE KEY-----)/m)[0][0]

server_options = {
  :BindAddress => "127.0.0.1",
  :Port => 3131,
  :AccessLog => [],
  :SSLEnable => true,
  :SSLVerifyClient => OpenSSL::SSL::VERIFY_NONE,
  :SSLPrivateKey => OpenSSL::PKey::RSA.new(ssl_key),
  :SSLCertificate => OpenSSL::X509::Certificate.new(ssl_cert),
  :SSLCertName => [["CN", WEBrick::Utils::getservername]],
}

case ARGV.shift
when 'install'
  Peaberry::PlistInstaller.new.install
else
  Rack::Handler::WEBrick.run Peaberry::DotJs.new, server_options
end

__END__
-----BEGIN CERTIFICATE-----
MIIDLjCCAhYCCQCCOGQHne+djTANBgkqhkiG9w0BAQUFADBZMQswCQYDVQQGEwJB
VTETMBEGA1UECBMKU29tZS1TdGF0ZTEhMB8GA1UEChMYSW50ZXJuZXQgV2lkZ2l0
cyBQdHkgTHRkMRIwEAYDVQQDEwlsb2NhbGhvc3QwHhcNMTMxMTMwMjI1MTM2WhcN
MTQxMTMwMjI1MTM2WjBZMQswCQYDVQQGEwJBVTETMBEGA1UECBMKU29tZS1TdGF0
ZTEhMB8GA1UEChMYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMRIwEAYDVQQDEwls
b2NhbGhvc3QwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDYdJ7xyy8N
WfJQ5aP9z+5ISej7O3/6M6j9zbKS/+Gj8SzonKpCs+ub0oCdrws1pIXTDqlGqV6t
pST1ouIjKWdEFp/c/w0/aXksgeR9J9wOEu7phH4AcPwU6DsXOk187SRX38lXyHzj
VY2/CLe9kmfAdA3f6zLmyziYaT13QNa7gymNaSME81BcjZ5AgxZSkD6jQraPSLFM
vFCE1BY3+YK8Bei/DEYlCW+/7j9JK6AxNdaDvumP/cRs29VfNQXTXF9QATPO1/mQ
jCLnnK9jVPEWWbbQ6uY69Cd90reHaXTyqVqVHPnIFBB7yRnMqewL3CiX2ZPvEuyD
BwohtY3aZROHAgMBAAEwDQYJKoZIhvcNAQEFBQADggEBAH8pZGiR1sX8zIo9E3p7
tXMNi6FbkdEAlwkFoPVTd26tHp083Aq26SB5539MeD7sTWzgzqBXbRm20HrhU0tA
7e3pIwT9EgEkncZGLmZS9hzr+xoBhKuq+GP37NL/vtBSJGRd9FYIuXide0vtbZ97
tkEJGhtKvZ86jkuIppOZtaBqfV/c+ClEd4uEX/yK8m1BzDViWN7ArXB48po2lYsA
Z1AyKhZX5O8WZVzrwSJiX92Kl+9Kk/4YCZ1lV8QFszuIP3Uqnh65a7IEepT1gsZd
zdyPm39NH3qFylxzXHVRv5OgXk94ainjPrxWRotRC1ihjQ7ht/r9e4yBYR05jCt4
bOE=
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA2HSe8csvDVnyUOWj/c/uSEno+zt/+jOo/c2ykv/ho/Es6Jyq
QrPrm9KAna8LNaSF0w6pRqleraUk9aLiIylnRBaf3P8NP2l5LIHkfSfcDhLu6YR+
AHD8FOg7FzpNfO0kV9/JV8h841WNvwi3vZJnwHQN3+sy5ss4mGk9d0DWu4MpjWkj
BPNQXI2eQIMWUpA+o0K2j0ixTLxQhNQWN/mCvAXovwxGJQlvv+4/SSugMTXWg77p
j/3EbNvVXzUF01xfUAEzztf5kIwi55yvY1TxFlm20OrmOvQnfdK3h2l08qlalRz5
yBQQe8kZzKnsC9wol9mT7xLsgwcKIbWN2mUThwIDAQABAoIBACojGcYMPc6lkex5
p+EDF2nvKXGu9YzpfZ5a6sZ/FZfqnUlzJhnyGI2u/uazasU4j+y0T/O3iPzYx0ci
PE+IAdhZZymIZTXQ/IvThX1vwwDiYqwG5NiFJi2Tv90Xtnn5WDfbEsEKAHXo870a
n1pCI/xtGz5Z9QDE0vGomxSaBLNfy2XlmWJAnFb8hGjYVZdd+qVnVHZpn93RhEyT
aedudVbGSfY4n5yOyYfZzffToYUdQrNQZLFj0l0ICyp0es8UMV4Mk1RsDfWKT8wP
lD8SOtopgk9BNB77XpNkhYX/MpLDvh4sdOrYnJyptl4c/a3vZkO9z6Gi3witeQSH
Z6PMXjECgYEA+lgkJ2MZanDtvONbS/pjmRiK7fhEt1J21G5NZYyM1XQLZ44/qEjh
TAnHOd/MV9VH4C7OH8L2VD8lkGdGLCtzWRZxVOAGrWfS4hSjiSGocCiK1l8eitlO
Vdk8jsEPpHsQyY/eE+ro0ZziBMajhYQkn7ux2vEW2F35pNSj2R+k/hUCgYEA3Vh8
La3uUDJ62dT5RN9YtgIcMhnsX5orHagCXcfe4E3OGq8fQEoRyMzroUAVsbrdjVX2
SUNyg7SgZMhsmPj0xiE0BZmM00Adb2jWY6UcT+FR5a+7MXCqzdrxZnynk/1O8oCE
yRA50wLk7zkV2vlEl+01qTD7YgykYJDDSQg0TisCgYAHmAzgtPzcYbiUdkEauOm0
hy4PsexDs1ivcPkgD3dmMjL2XTZJIIzVBabpdoR4VZvsjP7rr7pRK+kzzC4wwNCq
7ydY78LEF9YpzX54dnDplhFAF3qRs63QpNpVaj3TO3hy5M5TxFhzo1Kn2m6zaiLC
RatLfOy4e4FLIrglqfQTUQKBgCLwecGYJ/sezMef160oeE9aq+q4rtg0dMPcpmr5
RtQvU+5gYFV8m6wPtM4iWIpSjfBmdlcAP45Mr9jYzlOjULgJu7V6lIEwKLVSXi0i
fgKZ9ZyFDc5zE3MlMV/VI3q3zIN5B/zZA9esKEkewLVtDYfR2NuZMMU8a6IWl8zq
b587AoGBAO8gm6j2T2J3mYnk9+7vPW71qr2gBMy4TTrUnytEfU742sxpJkLH69KA
d/sLlg2FdclOigSnHxfMVMBkXomkUy1CtBazgAwb6hGpblpwaCWm9Z0om9hx63CV
JJ9HYUsNm+QRchMyvU+VuhuUcAvDeMpyLE7r1mOCLNBcijXY4St3
-----END RSA PRIVATE KEY-----
