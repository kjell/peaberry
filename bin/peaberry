#!/usr/bin/ruby
# -*- encoding: UTF-8 -*-

require 'rubygems'
begin
  require 'bundler/setup'
rescue LoadError => e
  # ignore
end

require 'peaberry'
require 'webrick'
require 'webrick/https'
require 'openssl'

ssl_info = DATA.read
ssl_cert = ssl_info.scan(/(-----BEGIN CERTIFICATE-----.+?-----END CERTIFICATE-----)/m)[0][0]
ssl_key  = ssl_info.scan(/(-----BEGIN RSA PRIVATE KEY-----.+?-----END RSA PRIVATE KEY-----)/m)[0][0]

server_options = {
  :BindAddress => "127.0.0.1",
  :Port => 3131,
  :AccessLog => [],
  :SSLEnable => true,
  :SSLVerifyClient => OpenSSL::SSL::VERIFY_NONE,
  :SSLPrivateKey => OpenSSL::PKey::RSA.new(ssl_key),
  :SSLCertificate => OpenSSL::X509::Certificate.new(ssl_cert),
  :SSLCertName => [["CN", WEBrick::Utils::getservername]],
}

case ARGV.shift
when 'install'
  Peaberry::PlistInstaller.new.install
else
  Rack::Handler::WEBrick.run Peaberry::DotJs.new, server_options
end

__END__
-----BEGIN CERTIFICATE-----
MIIDHDCCAgQCCQDVp+73AbDnNzANBgkqhkiG9w0BAQUFADBQMQswCQYDVQQGEwJV
UzELMAkGA1UECBMCTU4xDTALBgNVBAcTBE1wbHMxETAPBgNVBAoTCFBlYWJlcnJ5
MRIwEAYDVQQDEwlsb2NhbGhvc3QwHhcNMTQxMTIyMDYzOTI3WhcNMTUxMTIyMDYz
OTI3WjBQMQswCQYDVQQGEwJVUzELMAkGA1UECBMCTU4xDTALBgNVBAcTBE1wbHMx
ETAPBgNVBAoTCFBlYWJlcnJ5MRIwEAYDVQQDEwlsb2NhbGhvc3QwggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQCcQiKB+k0N/IUT8eK6i/zs/kdbbcQSfLam
ysXKCoxCuaTVYRRRVIGysEflWr+Jn0DIbtB3TviWzEVMyuVLxy9cKesTmvghvRYc
Y+XtlmbinDf3P2vcQWPE8o+8Nc+s4quxG4MW/nZi56aIPBskoobCWJKlHANu0e43
uKgBHb5QzglLoFhA0Fpt6r1/jiBsc7Pk2Tdg6C8LhOSj4/qxbooRW+u2adVOg+rd
Xwc41Urj/1IsHpyEjqVBDT1Zy+rSdozgcDmHKT0HN+5Se01LlB3SO6Zi7GomrUEP
+j0i5Cgg2OQE8jnH87Yb5UyMHFPrpKv6YRjPgH483YhKUm0E7XNLAgMBAAEwDQYJ
KoZIhvcNAQEFBQADggEBAHaf0OXbnnvaCmFYuiZ+CJi/YKaDBJGDmtAjPuXk+/6q
sZ20Vsa0SvnFXiT71rEyd0wZYHKCb6/r4NqZHyiMBAOhS7KxmIeHUmzEE2q5ZgwY
Dk7citVEPPdrZXfhVQS/2lYXhV4vGoAg68alD5poAf4SXqHH+s+8QV1orDBT8QIy
lS064UNBhGHvHIxJmsfTaTzLSrTQ+CAbPfTXRzZdmu2N4jiRBc7kbyBFTfBzTcS0
gH4V4rxcribqqi/WGK8ub2nefIfkmbTkb2BHaR1kDCi7Y55dkTS1iySJmcE42pQ/
ZJ3vy/ecxkJRczYfcQbrwbhCGH8X2skWffIUr3lDlYI=
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAnEIigfpNDfyFE/Hiuov87P5HW23EEny2psrFygqMQrmk1WEU
UVSBsrBH5Vq/iZ9AyG7Qd074lsxFTMrlS8cvXCnrE5r4Ib0WHGPl7ZZm4pw39z9r
3EFjxPKPvDXPrOKrsRuDFv52YuemiDwbJKKGwliSpRwDbtHuN7ioAR2+UM4JS6BY
QNBabeq9f44gbHOz5Nk3YOgvC4Tko+P6sW6KEVvrtmnVToPq3V8HONVK4/9SLB6c
hI6lQQ09Wcvq0naM4HA5hyk9BzfuUntNS5Qd0jumYuxqJq1BD/o9IuQoINjkBPI5
x/O2G+VMjBxT66Sr+mEYz4B+PN2ISlJtBO1zSwIDAQABAoIBAGdn9MIjTF7XH5Il
Xq+o+EY1uC8vIrRBR/Z09hNQi6WUiRqUVgfEbtg7hDipp1uBwjNh8h8iaawRnkLF
epx9QkAxlVmyEkbxhPJgwcZK4+dPDlJW7CAkPcwV4TziN37nuktIM6ZB20J0nmZF
sIi77YYra1BMi5EI6CaD0tp6Pnnl9tCv4Ews5DnMkhXp5dyE8fFea1NCXNtuJY43
zLeQzx7nusLipP0kH8s7byK9r5gLZpfzp0M0EjLdUWOUd7RmEbIlC5jJRw4yPHr1
b+sGurJ/TcEwJfpv/j481BKbfeONbgiAVZHJKSKpwoMEU3/dtWg1rkj9H8KbFDB3
S807ehECgYEAyl9HvQpgkwmAIO6ldFkwDWkyZBqbJqsBjaYs4tzdhQYRsoEZW60J
exSsz5MzdQps3AH+mXGiYZuBERHwVub07irJb+8Gca/YfOZE8uQG55kV+iDdcMrR
BTUJlr1geQ1LfJhbtgeg60ntHl7Ul0hCvlC2XBSp9cgxf5qEw02SfqcCgYEAxaqJ
7GXmLD3d/IR3UW5TiaP9EkgrAkZbsQRRd3s84/GGiglCl7xdSJsMm+7MErVS3LXF
BUnMXp3RX+yLOQNm20gj6hVu55U5uIgGvJ9mLEmjqJhwa7PSjKNgpVxqPYaip/n6
n7271Mv6lO0sBsxvP8gVQR+WuG85il8m5frKvr0CgYEAuCzWoRjco3S2A0KtmaHB
tbLThX8hTKO9GijuGNlhUTsgyA/uAB0Oz9EVJSSWZCJEyEWYbBWa7rITWHG3BZ/T
sR2HjjM+7iBXKfR3M4aLMiOEeMuIPKqYZ+DJBUL8la6f0JjoflWbAgeZoVY0rCm7
dHEIRe0YcPLs+XCq+wOSG2kCgYA4rPBE9uarUsXejIDFuXN8aKe8YTLrwQ6zT8Co
GI7Z8LuZwpP0e87nbYWNBEhBKPpsTDYEkSdnDasl7OXyX/ZS83lQufqFrjTRozcD
SFT8Z9TkF2lMiE/bgVDJuRjBMWRb84IX4UgE+MONhf90p5NSX2UwugT2NvXxpdy6
XlFZpQKBgHVS86vcWGVUFY2wk2q8jrH0nZgHpbmmdnjSwxisBZ/vSidgmiF7Ir6V
qpUEUhhh0uLhFSMwkJYROPlZ6ueYUe2gopkt6OkayT+9NCp+SySWmgydXNk/oRmd
bWIQ6nyLt2kKyqMlH0pvKVqOittBWCuvZ327NdMZDzGqOzWQSYcZ
-----END RSA PRIVATE KEY-----
